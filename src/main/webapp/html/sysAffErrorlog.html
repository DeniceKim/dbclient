<!DOCTYPE html>
<html>
<head>
<title>SysAffErrorLogView</title>
<link href='css/global.css' rel='stylesheet' type='text/css' />
<link href='lib/jquery-ui-1.11.2/jquery-ui.min.css' media='screen' rel='stylesheet' type='text/css' />
<script src='lib/jquery-1.8.0.min.js' type='text/javascript'></script>
<script src='lib/jquery-ui-1.11.2/jquery-ui.min.js' type='text/javascript'></script>
<script src='lib/utils.js' type='text/javascript'></script>
<script type="text/javascript">
	var getMenuData = function(){
		$.getJSON( "/api-docs/api/log", function( data ) {
			var menu= [];
			var menuDesc= [];
			$.each(data.apis, function() {
				$.each(this.operations, function() {
					if(this.nickname == 'findLogHandle'){
						$.each(this.parameters, function(loop) {
							menuDesc[loop] = this.description; 
							menu[loop]="";
							if(null!=this.enum){
								var defaultValue = this.defaultValue;
								menu[loop]+='<select name="'+this.name+'">';
								$.each(this.enum,function(){
									var selected = this==defaultValue ? 'selected' : "";
									menu[loop]+='<option value="'+this+'" '+selected+'>'+this+'</option>';
								});
								menu[loop]+='</select>';
								
							} else if(this.name == "classTxt"){
								menu[loop]+='<select name="'+this.name+'" onclick="findClass()"><select>';
							} else if(this.name == "methodTxt"){
								menu[loop]+='<select name="'+this.name+'"><select>';
							} else {
								var addDatePicker = "";
								if(this.format == 'date-time'){
									addDatePicker = 'onclick="addDate(this)"';
								}
								menu[loop]+='<input type="text" name="'+this.name+'" '+addDatePicker+' value="'+this.defaultValue+'"/ size="12">';
							}
						});
					}
				});
			});
			console.log(menu);
			
			var html='<table class="table-list" witdh="100%">';
			html+='<tr>';
			for(var i=0;i<menuDesc.length;i++){
				html+='<th>'+menuDesc[i]+'</th>';
			}
			html+='</tr>';
			html+='<tr>';
			for(var i=0;i<menu.length;i++){
				html+='<td>'+menu[i]+'</td>';
			}
			html+='</tr>';
			html+='</table>';
			$("#menu").html(html);
			$("#menu").html($("#menu").html() +'<br/> <input type="button" name="excute" value="검색" onclick="findSysAffErrorLog()">');
			findClass();
		});
	};
	
	var findClass=function(){
		var className = [];
		var methodName = [];
		if($("[name='classTxt']").find("> option").length == 0){
			$.getJSON( "/log/getLogWriteClassAndMethod", function( data ) {
				var classLoop=0;
				$.each(data.result, function(loop) {
					$.each(this, function(key,value) {
						if(!inArray(key, className)){
							className[classLoop] = key;
							classLoop++;
						}
						methodName[loop] = []
						methodName[loop][0] = key;
						methodName[loop][1] = value; 
					});
				});
				$("[name='classTxt']").append("<option value=''>- class select -</option>");
				$.each(className,function(loop){
					$("[name='classTxt']").append("<option value='"+this+"'>"+this+"</option>");					
				});
				// method 저장 
				$("#menu").data("methodName",methodName)
			});
		} else {
			var methodName = $("#menu").data("methodName");
			$("[name='methodTxt']").find("> option").each(function(){
				$(this).remove();					
			});
			$("[name='methodTxt']").append("<option value=''>- method select -</option>");				
			if($("[name='classTxt']").val() !=""){
				$.each(methodName,function(loop){
					if(this[0] == $("[name='classTxt']").val()){
						$("[name='methodTxt']").append("<option value='"+this[1]+"'>"+this[1]+"</option>");							
					}
				});
			}
		}
	};

	getMenuData();
	
	var findSysAffErrorLog = function(){
		$.getJSON("/log/findLog", $("[name='frmFindLog']").serialize(),function( data ) {
			showLoading();
			var head = [];
			var body = [];
			$("#desc").html("");
			$("#desc").html("검색일 : " + new Date() + "<br/>");
			
			if(data.status!=200){
				$("#desc").html($("#desc").html()+"데이터가 없습니다.");
				return;
			}
			
			$.each(data.result, function(loop) {
				body[loop] = [];

				var columnLoop = 0;
				$.each(this, function(key,value) {
					if(loop == 0){
						head[columnLoop]=key;
					}
					body[loop][columnLoop]=htmlspecialchars(value);
					columnLoop++;
				});
			});
			
			var html = '<table class="table-list">';
			$.each(body,function(rowLoop){
				if(rowLoop==0){
					html+="<tr>";				
					$.each(head,function(headLoop){
						html+="<th>"+this+"</th>";
					});
					html+="</tr>";
				}
				html+="<tr>";
				$.each(this,function(columnLoop){
					html+="<td>"+this+"</td>";
				});
				html+="</tr>";					
			});
			html+="</table>";
			$("#desc").html($("#desc").html()+html);
			hideLoading();
		});
	};
	var addDate=function(obj){
		$(obj).datepicker({
			altFormat: 'yy-mm-dd',
			dateFormat: 'yy-mm-dd',
			changeYear: true,
			inline: true
		});
		$(obj).datepicker( "show" );
	};

	function htmlspecialchars(str) {
		 if (typeof(str) == "string") {
		  str = str.replace(/&/g, "&amp;"); /* must do &amp; first */
		  str = str.replace(/"/g, "&quot;");
		  str = str.replace(/'/g, "&#039;");
		  str = str.replace(/</g, "&lt;");
		  str = str.replace(/>/g, "&gt;");
		  }
		 return str;
	 }
	</script>
</head>
<body>
	<div id="loading" style="display: none;position: absolute;width: 300px;height: 35px;top:300px;left:30% ;background:gray;">
		<div style="color: white;"> <br/> <strong> Lading Now ......</strong> </div>
	</div>
	<div class="header">
		<div id="topMenu">
			<table>
				<tr>
					<td valign="top">
						<div id="logo"></div>
						<div id="marketPlaceList" style="text-align: left">
							<h1> SysAffErrorLogView </h1>
						</div>
					</td>
				</tr>
			</table>
		</div>
		<div id="topPadding"></div>
	</div>
	<div id="wrapper-outer">
		<div id="wrapper" align="center">
		
			<div style="width: 100%">
				<form name="frmFindLog" method="get">
				<div id="menu"></div>
				</form>
				<br/>
				<div id="desc"></div>
			</div>

		</div>
	</div>
	<div id="bottomMenu">
		<table>
			<tr>
				<td>Copyrightⓒ Song7749 Co., Ltd. All Rights Reserved.</td>
			</tr>
		</table>
	</div>
</body>
</html>